(()=>{var e={};e.id=938,e.ids=[938],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},92300:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>x,routeModule:()=>b,serverHooks:()=>m,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{POST:()=>_});var i=r(96559),o=r(48088),n=r(37719),a=r(32190),u=r(97877),c=r(66437);function p(e){let t=e.items?.data?.[0]?.current_period_start;return t||e.current_period_start||null}function d(e){let t=e.items?.data?.[0]?.current_period_end;return t||e.current_period_end||null}function l(e){let t=e.subscription;return t?"string"==typeof t?t:t&&"object"==typeof t&&t.id?t.id:null:null}async function _(e){let t;if(!process.env.STRIPE_SECRET_KEY||!process.env.STRIPE_WEBHOOK_SECRET)return a.NextResponse.json({error:"Stripe is not configured. Webhook processing is disabled."},{status:503});let r=new u.A(process.env.STRIPE_SECRET_KEY),s=process.env.STRIPE_WEBHOOK_SECRET,i=await e.text(),o=e.headers.get("stripe-signature");try{t=r.webhooks.constructEvent(i,o,s)}catch(e){return console.error("Webhook signature verification failed:",e),a.NextResponse.json({error:"Invalid signature"},{status:400})}let n=(0,c.UU)("https://jtqlamkrhdfwtmaubfrc.supabase.co",process.env.SUPABASE_SECRET_KEY);try{switch(t.type){case"checkout.session.completed":{let e=t.data.object;if("subscription"===e.mode&&e.subscription){let t=await r.subscriptions.retrieve(e.subscription),s=e.metadata?.user_id,i=e.metadata?.product_id;if(s&&i){let e=p(t),r=d(t),{error:o}=await n.from("subscriptions").upsert({user_id:s,product_id:i,stripe_subscription_id:t.id,stripe_customer_id:t.customer,status:t.status,current_period_start:e?new Date(1e3*e).toISOString():new Date().toISOString(),current_period_end:r?new Date(1e3*r).toISOString():new Date().toISOString(),cancel_at_period_end:t.cancel_at_period_end},{onConflict:"stripe_subscription_id"});o&&console.error("Error creating subscription record:",o)}}break}case"customer.subscription.updated":{let e=t.data.object,r={status:e.status,cancel_at_period_end:e.cancel_at_period_end,updated_at:new Date().toISOString()},s=p(e),i=d(e);if(s&&(r.current_period_start=new Date(1e3*s).toISOString()),i&&(r.current_period_end=new Date(1e3*i).toISOString()),e.items&&e.items.data.length>0){let t=e.items.data[0].price.id,{data:s,error:i}=await n.from("prices").select("product_id").eq("stripe_price_id",t).single();!i&&s?r.product_id=s.product_id:console.error("Error finding product for price:",t,i)}let{error:o}=await n.from("subscriptions").update(r).eq("stripe_subscription_id",e.id);o&&console.error("Error updating subscription:",o);break}case"customer.subscription.deleted":{let e=t.data.object,{error:r}=await n.from("subscriptions").update({status:"canceled",updated_at:new Date().toISOString()}).eq("stripe_subscription_id",e.id);r&&console.error("Error canceling subscription:",r);break}case"invoice.payment_succeeded":{let e=t.data.object,r=l(e);if(r){let{error:e}=await n.from("subscriptions").update({status:"active",updated_at:new Date().toISOString()}).eq("stripe_subscription_id",r);e&&console.error("Error updating subscription on payment success:",e)}break}case"invoice.payment_failed":{let e=t.data.object,r=l(e);if(r){let{error:e}=await n.from("subscriptions").update({status:"past_due",updated_at:new Date().toISOString()}).eq("stripe_subscription_id",r);e&&console.error("Error updating subscription on payment failure:",e)}break}default:console.log(`Unhandled event type: ${t.type}`)}return a.NextResponse.json({received:!0})}catch(e){return console.error("Error processing webhook:",e),a.NextResponse.json({error:"Webhook processing failed"},{status:500})}}let b=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/subscriptions/webhook/route",pathname:"/api/subscriptions/webhook",filename:"route",bundlePath:"app/api/subscriptions/webhook/route"},resolvedPagePath:"/Users/sydnee/icanswimbeta/src/app/api/subscriptions/webhook/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:f,workUnitAsyncStorage:g,serverHooks:m}=b;function x(){return(0,n.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:g})}},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[447,437,580,877],()=>r(92300));module.exports=s})();